{% extends "base.html" %}

{% block title %}Producto: {{ producto.nombre }}{% endblock %}
{% block subtitle %}Detalles del producto{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Información del Producto</h5>
                <div class="btn-group">
                    <a href="{{ url_for('editar_producto', id=producto.id_producto) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil me-1"></i> Editar
                    </a>
                    <a href="{{ url_for('listar_productos') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i> Volver
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Código del Producto</h6>
                        <p class="fs-5">
                            <span class="badge bg-primary">PROD-{{ producto.id_producto|string.rjust(6, '0') }}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Nombre</h6>
                        <p class="fs-4">{{ producto.nombre }}</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="text-muted">Precio de Compra</h6>
                        <p class="fs-3 text-primary">${{ producto.precio_compra }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Precio de Venta</h6>
                        <p class="fs-3 text-success">${{ producto.precio_venta }}</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="text-muted">Descripción</h6>
                    <div class="border rounded p-3 bg-light">
                        {{ producto.descripcion or "Sin descripción" }}
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6 class="text-muted">Proveedor</h6>
                        <p>
                            {% if producto.proveedor %}
                                <strong>{{ producto.proveedor.nombre }}</strong><br>
                                <small class="text-muted">
                                    RUC: {{ producto.proveedor.ruc }}<br>
                                    Tel: {{ producto.proveedor.telefono or "No disponible" }}
                                </small>
                            {% else %}
                                <span class="text-muted">No asignado</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Fecha de Registro</h6>
                        <p class="text-muted">Información no disponible</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Estado de Inventario</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <div class="display-1 fw-bold {% if producto.stock > 10 %}text-success{% elif producto.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                        {{ producto.stock }}
                    </div>
                    <p class="text-muted">Unidades en Stock</p>
                </div>
                
                <div class="mb-4">
                    <div class="progress" style="height: 20px;">
                        {% set porcentaje = (producto.stock / 100 * 100) if producto.stock <= 100 else 100 %}
                        <div class="progress-bar {% if producto.stock > 10 %}bg-success{% elif producto.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}" 
                             style="width: {{ porcentaje }}%"
                             role="progressbar">
                            {{ producto.stock }} unidades
                        </div>
                    </div>
                </div>
                
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Valor en Inventario</span>
                        <strong>${{ "%.2f"|format(producto.precio_compra * producto.stock) }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Margen de Ganancia</span>
                        <strong class="text-success">
                            {% set margen = ((producto.precio_venta - producto.precio_compra) / producto.precio_compra * 100) if producto.precio_compra > 0 else 0 %}
                            {{ "%.1f"|format(margen) }}%
                        </strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Estado</span>
                        <span class="badge {% if producto.stock > 10 %}bg-success{% elif producto.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                            {% if producto.stock > 10 %}
                                DISPONIBLE
                            {% elif producto.stock > 0 %}
                                BAJO STOCK
                            {% else %}
                                AGOTADO
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('crear_compra') }}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-cart-plus me-2"></i> Realizar Compra
                    </a>
                    <a href="{{ url_for('crear_venta') }}" class="btn btn-primary w-100">
                        <i class="bi bi-cart-check me-2"></i> Realizar Venta
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">Últimas Ventas</h6>
            </div>
            <div class="card-body">
                {% if ventas %}
                    <div class="list-group list-group-flush">
                        {% for detalle in ventas %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <small class="text-muted">Venta #{{ detalle.id_venta }}</small>
                                    <p class="mb-1">{{ detalle.cantidad }} unidades</p>
                                    <small class="text-muted">${{ detalle.precio_unitario }} c/u</small>
                                </div>
                                <div class="text-end">
                                    <strong>${{ detalle.cantidad * detalle.precio_unitario }}</strong>
                                    <br>
                                    <small class="text-muted">{{ detalle.venta_rel.fecha_venta.strftime('%d/%m/%Y') }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">No hay ventas registradas</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">Últimas Compras</h6>
            </div>
            <div class="card-body">
                {% if compras %}
                    <div class="list-group list-group-flush">
                        {% for detalle in compras %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <small class="text-muted">Compra #{{ detalle.id_compra }}</small>
                                    <p class="mb-1">{{ detalle.cantidad }} unidades</p>
                                    <small class="text-muted">${{ detalle.precio_unitario }} c/u</small>
                                </div>
                                <div class="text-end">
                                    <strong>${{ detalle.subtotal }}</strong>
                                    <br>
                                    <small class="text-muted">{{ detalle.compra_rel.fecha_compra.strftime('%d/%m/%Y') }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">No hay compras registradas</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}